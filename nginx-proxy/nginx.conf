worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $host - [$time_local] "$request" '
                    '$status $body_bytes_sent';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 100M;

    # Route based on Host header
    map $host $backend {
        default                         "dashboard";
        
        # Dashboard / Root
        "dashboard.mulecube.local"      "dashboard";
        "dashboard.mulecube.net"        "dashboard";
        "mulecube.local"                "dashboard";
        "mulecube.net"                  "dashboard";
        "www.mulecube.local"            "dashboard";
        "www.mulecube.net"              "dashboard";
        "192.168.42.1"                  "dashboard";
        
        # AI Services
        "translate.mulecube.local"      "libretranslate";
        "translate.mulecube.net"        "libretranslate";
        "ai.mulecube.local"             "openwebui";
        "ai.mulecube.net"               "openwebui";
        "ollama.mulecube.local"         "ollama";
        "ollama.mulecube.net"           "ollama";
        
        # Knowledge
        "wiki.mulecube.local"           "kiwix";
        "wiki.mulecube.net"             "kiwix";
        "kiwix.mulecube.local"          "kiwix";
        "kiwix.mulecube.net"            "kiwix";
        "maps.mulecube.local"           "maps";
        "maps.mulecube.net"             "maps";
        "books.mulecube.local"          "calibre";
        "books.mulecube.net"            "calibre";
        "calibre.mulecube.local"        "calibre";
        "calibre.mulecube.net"          "calibre";
        
        # Productivity
        "docs.mulecube.local"           "cryptpad";
        "docs.mulecube.net"             "cryptpad";
        "cryptpad.mulecube.local"       "cryptpad";
        "cryptpad.mulecube.net"         "cryptpad";
        "pad.mulecube.local"            "cryptpad";
        "pad.mulecube.net"              "cryptpad";
        "draw.mulecube.local"           "excalidraw";
        "draw.mulecube.net"             "excalidraw";
        "excalidraw.mulecube.local"     "excalidraw";
        "excalidraw.mulecube.net"       "excalidraw";
        "pdf.mulecube.local"            "bentopdf";
        "pdf.mulecube.net"              "bentopdf";
        
        # Files & Sync
        "files.mulecube.local"          "filebrowser";
        "files.mulecube.net"            "filebrowser";
        "sync.mulecube.local"           "syncthing";
        "sync.mulecube.net"             "syncthing";
        "syncthing.mulecube.local"      "syncthing";
        "syncthing.mulecube.net"        "syncthing";
        
        # Communication
        "chat.mulecube.local"           "element";
        "chat.mulecube.net"             "element";
        "element.mulecube.local"        "element";
        "element.mulecube.net"          "element";
        "matrix.mulecube.local"         "conduit";
        "matrix.mulecube.net"           "conduit";
        "conduit.mulecube.local"        "conduit";
        "conduit.mulecube.net"          "conduit";
        "mesh.mulecube.local"           "meshtastic";
        "mesh.mulecube.net"             "meshtastic";
        "meshtastic.mulecube.local"     "meshtastic";
        "meshtastic.mulecube.net"       "meshtastic";
        
        # Tools
        "tools.mulecube.local"          "ittools";
        "tools.mulecube.net"            "ittools";
        "network.mulecube.local"        "networktools";
        "network.mulecube.net"          "networktools";
        "archive.mulecube.local"        "openarchiver";
        "archive.mulecube.net"          "openarchiver";
        "emergency.mulecube.local"      "emergency";
        "emergency.mulecube.net"        "emergency";
        "links.mulecube.local"          "linkwarden";
        "links.mulecube.net"            "linkwarden";
        
        # Infrastructure / Monitoring
        "status.mulecube.local"         "uptimekuma";
        "status.mulecube.net"           "uptimekuma";
        "monitor.mulecube.local"        "beszel";
        "monitor.mulecube.net"          "beszel";
        "beszel.mulecube.local"         "beszel";
        "beszel.mulecube.net"           "beszel";
        "dns.mulecube.local"            "pihole";
        "dns.mulecube.net"              "pihole";
        "pihole.mulecube.local"         "pihole";
        "pihole.mulecube.net"           "pihole";
        "apps.mulecube.local"           "apkrepo";
        "apps.mulecube.net"             "apkrepo";

        # Navigation / Marine
        "navigation.mulecube.local"     "signalk";
        "navigation.mulecube.net"       "signalk";
        "signalk.mulecube.local"        "signalk";
        "signalk.mulecube.net"          "signalk";
        "marine.mulecube.local"         "signalk";
        "marine.mulecube.net"           "signalk";

        # Control Panel - User
        "home.mulecube.local"           "homarr";
        "home.mulecube.net"             "homarr";
        "homarr.mulecube.local"         "homarr";
        "homarr.mulecube.net"           "homarr";

        # Control Panel - Admin
        "admin.mulecube.local"          "dockge";
        "admin.mulecube.net"            "dockge";
        "dockge.mulecube.local"         "dockge";
        "dockge.mulecube.net"           "dockge";
        "containers.mulecube.local"     "dockge";
        "containers.mulecube.net"       "dockge";
        "terminal.mulecube.local"       "terminal";
        "terminal.mulecube.net"         "terminal";
        "shell.mulecube.local"          "terminal";
        "shell.mulecube.net"            "terminal";
        "logs.mulecube.local"           "dozzle";
        "logs.mulecube.net"             "dozzle";
        "dozzle.mulecube.local"         "dozzle";
        "dozzle.mulecube.net"           "dozzle";

        # Control Panel - APIs
        "api.mulecube.local"            "statusapi";
        "api.mulecube.net"              "statusapi";
        "health.mulecube.local"         "statusapi";
        "health.mulecube.net"           "statusapi";
        "diagnostics.mulecube.local"    "diagnostics";
        "diagnostics.mulecube.net"      "diagnostics";
        "backup.mulecube.local"         "backupapi";
        "backup.mulecube.net"           "backupapi";
    }

    # Conditional WebSocket - only upgrade when client requests it
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # Upstreams - User Services
    upstream dashboard      { server 192.168.42.1:8087; }
    upstream openwebui      { server 192.168.42.1:8080; }
    upstream kiwix          { server 192.168.42.1:8082; }
    upstream maps           { server 192.168.42.1:8083; }
    upstream meshtastic     { server 192.168.42.1:8084; }
    upstream bentopdf       { server 192.168.42.1:8085; }
    upstream filebrowser    { server 192.168.42.1:8086; }
    upstream vaultwarden    { server 192.168.42.1:3000; }
    upstream emergency      { server 192.168.42.1:8088; }
    upstream ittools        { server 192.168.42.1:8089; }
    upstream uptimekuma     { server 192.168.42.1:8090; }
    upstream excalidraw     { server 192.168.42.1:8091; }
    upstream networktools   { server 192.168.42.1:8092; }
    upstream linkwarden     { server 192.168.42.1:8093; }
    upstream cryptpad       { server 192.168.42.1:8094; }
    upstream libretranslate { server 192.168.42.1:8095; }
    upstream conduit        { server 192.168.42.1:8097; }
    upstream element        { server 192.168.42.1:8098; }
    upstream calibre        { server 192.168.42.1:8099; }
    upstream beszel         { server 192.168.42.1:8100; }
    upstream apkrepo        { server 192.168.42.1:8101; }
    upstream pihole         { server 192.168.42.1:8081; }
    upstream ollama         { server 192.168.42.1:11434; }
    upstream syncthing      { server 192.168.42.1:8384; }
    upstream openarchiver   { server 192.168.42.1:3100; }
    upstream signalk        { server 192.168.42.1:8102; }

    # Upstreams - Control Panel
    upstream homarr         { server 192.168.42.1:7575; }
    upstream dockge         { server 192.168.42.1:5001; }
    upstream terminal       { server 192.168.42.1:7681; }
    upstream dozzle         { server 192.168.42.1:9999; }
    upstream statusapi      { server 192.168.42.1:9004; }
    upstream diagnostics    { server 192.168.42.1:9007; }
    upstream backupapi      { server 192.168.42.1:9005; }

    # HTTPS for Vaultwarden
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name vault.mulecube.local vault.mulecube.net passwords.mulecube.local passwords.mulecube.net;

        ssl_certificate /etc/nginx/certs/mulecube.crt;
        ssl_certificate_key /etc/nginx/certs/mulecube.key;
        ssl_protocols TLSv1.2 TLSv1.3;

        location / {
            proxy_pass http://vaultwarden;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }

    # Redirect vault HTTP to HTTPS
    server {
        listen 80;
        server_name vault.mulecube.local vault.mulecube.net passwords.mulecube.local passwords.mulecube.net;
        return 301 https://$host$request_uri;
    }

    # HTTP for everything else
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_name _;

        location /api/status/ {
            proxy_pass http://uptimekuma/api/status-page/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/status/heartbeat/ {
            proxy_pass http://uptimekuma/api/status-page/heartbeat/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location / {
            proxy_pass http://$backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Scheme $scheme;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
            proxy_busy_buffers_size 256k;
        }
    }
}
